## Workflow derived from https://github.com/r-lib/actions/tree/v2/examples and
##   https://github.com/yihui/crandalf/blob/main/.github/workflows/rev-check.yaml
##
## Need help debugging build failures? Start at https://github.com/r-lib/actions#where-to-find-help
name: 'revdeps-check'
description: 'Action to run reverse dependency checks for R packages'
author: 'Alex Chubaty'
inputs:
  quiet:
    description: "Logical. Suppress output from internal processes?"
    required: true
    default: true
  timeout:
    description: "Integer. Maximum time to wait (in minutes) for R CMD check to complete per revdep."
    required: true
    default: 30
runs:
  using: "composite"
  steps:
      - name: Install additional package dependencies
        run: |
          ## install separately; keep this order to avoid conflicts
          pak::pkg_install("fs")
          pak::pkg_install("HenrikBengtsson/revdepcheck.extras")
          pak::pkg_install("r-lib/revdepcheck")
          pak::pkg_install("achubaty/crancache@r-universe")
        shell: Rscript {0}

      - name: Check reverse dependencies
        run: |
          options(
            repos = c(
              PE = "https://predictiveecology.r-universe.dev",
              CRAN = "https://cloud.r-project.org"
            ),
            revdepcheck.num_workers = getOption("Ncpus", 2L)
          )

          omit_pkgs <- c(
            "SpaDES.project" ## omit b/c it circularly Suggests SpaDES.config
          )
          revdeps <- c(
            revdepcheck.extras::revdep_children(),
            revdepcheck.extras::revdep_grandchildren()
          ) |>
            setdiff(omit_pkgs)

          ## manual pre-installation (uses crancache)
          crancache::update_packages(lib.loc = .libPaths()[1], ask = FALSE)
          revdepcheck.extras::revdep_precache(pkgs = revdeps)

          ## sequentially install deps of each revdeps package in parallel;
          ## NOTE: PE pkgs aren't crancached, and will be installed each time.
          fs::path("revdep", "library", revdeps) |> fs::dir_create()
          if (Sys.info()[["sysname"]] != "Darwin") {
            ## skip on macos because of sporadic 'library.noindex/' path
            lapply(revdeps, revdepcheck:::deps_install, pkgdir = ".")
          }

          ## setup and run the checks
          revdepcheck.extras::revdep_init()
          revdepcheck::revdep_add(packages = revdeps)

          revdepcheck::revdep_check(
            num_workers = getOption("revdepcheck.num_workers", 2L),
            quiet = as.logical("${{ inputs.quiet }}"),
            timeout = as.difftime("${{ inputs.timeout }}", units = "mins")
          )
        shell: Rscript {0}

      - name: Upload check results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: ${{ runner.os }}-revdeps-check-results
          if-no-files-found: ignore
          path: |
            00check_diffs.html
            latex.txt
            recheck
            recheck2
            *.Rcheck
            *.Rcheck2
